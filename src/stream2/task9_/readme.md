–ú–æ–¥—É–ª—å ‚Ññ9 ‚Äî —Ü–µ parallelStream(), forEach(), forEachOrdered() ‚Äî –æ–¥–Ω–∞ –∑ —Ç–∏—Ö —Ç–µ–º, –¥–µ Java –ø–æ–∫–∞–∑—É—î —Å–≤—ñ–π ‚Äú–ø—ñ–¥–∫–∞–ø–æ—Ç–Ω–∏–π‚Äù —Ä—ñ–≤–µ–Ω—å.
–í–∏ –Ω–∞–≤—á–∏—Ç–µ—Å—è –±–∞—á–∏—Ç–∏, –∫–æ–ª–∏ –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ—Å—Ç—å —Ä–µ–∞–ª—å–Ω–æ –¥–æ–ø–æ–º–∞–≥–∞—î, –∫–æ–ª–∏ –≤–æ–Ω–∞ —à–∫–æ–¥–∏—Ç—å, —ñ —è–∫ –∑–±–µ—Ä–µ–≥—Ç–∏ –ø–æ—Ä—è–¥–æ–∫ –Ω–∞–≤—ñ—Ç—å —É parallel-–ø–æ—Ç–æ–∫–∞—Ö.

‚öôÔ∏è –ú–æ–¥—É–ª—å ‚Ññ9 ‚Äî parallelStream(), forEach() vs forEachOrdered()

üìò –ú–µ—Ç–∞:

–∑—Ä–æ–∑—É–º—ñ—Ç–∏, —â–æ parallelStream() —Ä–æ–∑–±–∏–≤–∞—î —Ä–æ–±–æ—Ç—É –Ω–∞ –∫—ñ–ª—å–∫–∞ –ø–æ—Ç–æ–∫—ñ–≤;

–Ω–∞–≤—á–∏—Ç–∏—Å—è –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ –ø–æ—Ä—è–¥–æ–∫;

—É—Å–≤—ñ–¥–æ–º–∏—Ç–∏ —Ä—ñ–∑–Ω–∏—Ü—é –º—ñ–∂ ‚Äú–≤–∏–∫–æ–Ω–∞—Ç–∏ —à–≤–∏–¥—à–µ‚Äù —ñ ‚Äú–≤–∏–∫–æ–Ω–∞—Ç–∏ –≤–ø–æ—Ä—è–¥–∫–æ–≤–∞–Ω–æ‚Äù.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 1 ‚Äî –ó–≤–∏—á–∞–π–Ω–∏–π forEach (–ø–æ—Å–ª—ñ–¥–æ–≤–Ω–∏–π)

üìã –£–º–æ–≤–∞:
–í–∏–≤–µ–¥–∏ —á–∏—Å–ª–∞ 1‚Äì5 —É –∑–≤–∏—á–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É.

List.of(1, 2, 3, 4, 5)
.stream()
.forEach(System.out::print);

// 12345


üß† –í—Å–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –≤ –æ–¥–Ω–æ–º—É –ø–æ—Ç–æ—Ü—ñ, –ª—ñ–Ω—ñ–π–Ω–æ.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 2 ‚Äî –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∏–π –ø–æ—Ç—ñ–∫

üìã –£–º–æ–≤–∞:
–ó–∞–ø—É—Å—Ç–∏ —Ç–æ–π —Å–∞–º–∏–π –∫–æ–¥ —ñ–∑ parallelStream().

List.of(1, 2, 3, 4, 5)
.parallelStream()
.forEach(System.out::print);

// –ù–∞–ø—Ä–∏–∫–ª–∞–¥: 43125 (–ø–æ—Ä—è–¥–æ–∫ –≤–∏–ø–∞–¥–∫–æ–≤–∏–π)


üß† –ï–ª–µ–º–µ–Ω—Ç–∏ –º–æ–∂—É—Ç—å –æ–±—Ä–æ–±–ª—è—Ç–∏—Å—å —É –±—É–¥—å-—è–∫–æ–º—É –ø–æ—Ä—è–¥–∫—É ‚Äî –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ CPU.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 3 ‚Äî forEachOrdered()

üìã –£–º–æ–≤–∞:
–ó–±–µ—Ä–µ–∂–∏ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π –ø–æ—Ä—è–¥–æ–∫ —É –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ–º—É –ø–æ—Ç–æ—Ü—ñ.

List.of(1, 2, 3, 4, 5)
.parallelStream()
.forEachOrdered(System.out::print);

// 12345


üß† –ì–∞—Ä–∞–Ω—Ç—É—î –ø–æ—Ä—è–¥–æ–∫, –∞–ª–µ –≤—Ç—Ä–∞—á–∞—î —á–∞—Å—Ç–∏–Ω—É –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 4 ‚Äî –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ—Ç–æ–∫—ñ–≤

üìã –£–º–æ–≤–∞:
–ü–æ–∫–∞–∂–∏, —É —è–∫–æ–º—É –ø–æ—Ç–æ—Ü—ñ –ø—Ä–∞—Ü—é—î –∫–æ–∂–µ–Ω –µ–ª–µ–º–µ–Ω—Ç.

List.of("A", "B", "C", "D")
.parallelStream()
.forEach(s ->
System.out.println(Thread.currentThread().getName() + " ‚Üí " + s)
);


üì§ –ù–∞–ø—Ä–∏–∫–ª–∞–¥:

ForkJoinPool.commonPool-worker-3 ‚Üí A  
main ‚Üí B  
ForkJoinPool.commonPool-worker-5 ‚Üí C  
ForkJoinPool.commonPool-worker-7 ‚Üí D


üß† –ú–æ–∂–Ω–∞ –ø–æ–±–∞—á–∏—Ç–∏ —Ä–æ–∑–ø–æ–¥—ñ–ª –ø–æ –ø–æ—Ç–æ–∫–∞—Ö.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 5 ‚Äî –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —á–∞—Å—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

üìã –£–º–æ–≤–∞:
–ü–æ—Ä—ñ–≤–Ω—è–π stream() —ñ parallelStream() –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –≤–µ–ª–∏–∫–∏—Ö –¥–∞–Ω–∏—Ö.

List<Integer> nums = IntStream.range(0, 1_000_000).boxed().toList();

long t1 = System.currentTimeMillis();
nums.stream().map(Math::sqrt).toList();
long t2 = System.currentTimeMillis();

nums.parallelStream().map(Math::sqrt).toList();
long t3 = System.currentTimeMillis();

System.out.println("Normal: " + (t2 - t1) + "ms");
System.out.println("Parallel: " + (t3 - t2) + "ms");


üß† –ù–∞ –≤–µ–ª–∏–∫–∏—Ö –æ–±—Å—è–≥–∞—Ö parallel –º–æ–∂–µ –±—É—Ç–∏ —à–≤–∏–¥—à–µ, –∞–ª–µ –Ω–µ –∑–∞–≤–∂–¥–∏.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 6 ‚Äî forEach() —ñ –∑–º—ñ–Ω–∞ –∫–æ–ª–µ–∫—Ü—ñ—ó (‚ö†Ô∏è)

üìã –£–º–æ–≤–∞:
–°–ø—Ä–æ–±—É–π –¥–æ–¥–∞–≤–∞—Ç–∏ –µ–ª–µ–º–µ–Ω—Ç–∏ –≤ List —É—Å–µ—Ä–µ–¥–∏–Ω—ñ parallelStream.

List<Integer> result = new ArrayList<>();

IntStream.range(1, 10).parallel().forEach(result::add);

System.out.println(result); // üò± –ú–æ–∂–µ –±—É—Ç–∏ –Ω–µ–ø–æ–≤–Ω–∏–º –∞–±–æ –∫–∏–Ω—É—Ç–∏ Exception


üß† –ü–æ–º–∏–ª–∫–∞: –ø–∞—Ä–∞–ª–µ–ª—å–Ω–µ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤ ArrayList –Ω–µ —î –±–µ–∑–ø–µ—á–Ω–∏–º.
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ ConcurrentLinkedQueue –∞–±–æ –∫–æ–ª–µ–∫—Ç–æ—Ä–∏.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 7 ‚Äî –ü—Ä–∞–≤–∏–ª—å–Ω–µ –∑–±–∏—Ä–∞–Ω–Ω—è –≤ –∫–æ–ª–µ–∫—Ü—ñ—é

üìã –£–º–æ–≤–∞:
–í–∏–∫–æ—Ä–∏—Å—Ç–∞–π Collector (thread-safe –∑–±–∏—Ä–∞–Ω–Ω—è).

List<Integer> result = IntStream.range(1, 10)
.parallel()
.boxed()
.collect(Collectors.toList());

System.out.println(result); // —É—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –ø—Ä–∏—Å—É—Ç–Ω—ñ

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 8 ‚Äî –ó–º—ñ—à–∞–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫ —ñ forEachOrdered

üìã –£–º–æ–≤–∞:
–ü–æ–±–∞—á —Ä—ñ–∑–Ω–∏—Ü—é –º—ñ–∂ –¥–≤–æ–º–∞ –≤–∏–∫–ª–∏–∫–∞–º–∏.

List.of("a", "b", "c", "d")
.parallelStream()
.peek(s -> System.out.println("peek: " + s))
.forEach(System.out::println);

System.out.println("---");

List.of("a", "b", "c", "d")
.parallelStream()
.peek(s -> System.out.println("peek: " + s))
.forEachOrdered(System.out::println);


üß† peek –∑–∞–≤–∂–¥–∏ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏–π, –∞–ª–µ forEachOrdered –≤–∏–≤–æ–¥–∏—Ç—å —É –ø—Ä–∞–≤–∏–ª—å–Ω—ñ–π —á–µ—Ä–∑—ñ.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 9 ‚Äî –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è reduce() –∑ parallelStream

üìã –£–º–æ–≤–∞:
–û–±—á–∏—Å–ª–∏ —Å—É–º—É –∑ –∞—Å–æ—Ü—ñ–∞—Ç–∏–≤–Ω–æ—é –æ–ø–µ—Ä–∞—Ü—ñ—î—é.

int sum = IntStream.rangeClosed(1, 5)
.parallel()
.reduce(0, Integer::sum);

System.out.println(sum); // 15 ‚úÖ


üß† reduce —É –ø–∞—Ä–∞–ª–µ–ª—ñ –±–µ–∑–ø–µ—á–Ω–∏–π —Ç—ñ–ª—å–∫–∏ –∑ –∞—Å–æ—Ü—ñ–∞—Ç–∏–≤–Ω–∏–º–∏ –æ–ø–µ—Ä–∞—Ü—ñ—è–º–∏ (+, *, min, max).

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 10 ‚Äî –ù–µ–±–µ–∑–ø–µ—á–Ω–µ reduce() (–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è –ø–æ–º–∏–ª–∫–∏)

üìã –£–º–æ–≤–∞:
–ü–æ–±–∞—á, —â–æ —Å—Ç–∞–Ω–µ—Ç—å—Å—è, —è–∫—â–æ —Ñ—É–Ω–∫—Ü—ñ—è –Ω–µ–∞—Å–æ—Ü—ñ–∞—Ç–∏–≤–Ω–∞.

int result = IntStream.rangeClosed(1, 5)
.parallel()
.reduce(0, (a, b) -> a - b);

System.out.println(result); // ‚ùì –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–ø–∞–¥–∫–æ–≤–∏–π


üß† –û–ø–µ—Ä–∞—Ü—ñ—è a - b –Ω–µ –∞—Å–æ—Ü—ñ–∞—Ç–∏–≤–Ω–∞ ‚Üí —Ä—ñ–∑–Ω—ñ —á–∞—Å—Ç–∏–Ω–∏ –ø–æ—Ç–æ–∫—ñ–≤ –æ–±—á–∏—Å–ª—é—é—Ç—å—Å—è –Ω–µ–∑–∞–ª–µ–∂–Ω–æ ‚Üí —Ö–∞–æ—Å.
–ó–∞–≤–∂–¥–∏ –ø–µ—Ä–µ–∫–æ–Ω—É–π—Å—è, —â–æ –æ–ø–µ—Ä–∞—Ü—ñ—è –∞—Å–æ—Ü—ñ–∞—Ç–∏–≤–Ω–∞ –ø–µ—Ä–µ–¥ parallelStream().

üí° –ü—ñ–¥—Å—É–º–æ–∫
–ú–µ—Ç–æ–¥	–ü–æ—Ä—è–¥–æ–∫	–ü–∞—Ä–∞–ª–µ–ª—å–Ω—ñ—Å—Ç—å	–ü—Ä–∏–º—ñ—Ç–∫–∞
.stream()	–∑–±–µ—Ä—ñ–≥–∞—î	‚ùå	–ø–æ—Å–ª—ñ–¥–æ–≤–Ω–∞ –æ–±—Ä–æ–±–∫–∞
.parallelStream()	–º–æ–∂–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏	‚úÖ	—à–≤–∏–¥—à–µ –Ω–∞ –≤–µ–ª–∏–∫–∏—Ö –¥–∞–Ω–∏—Ö
.forEach()	–Ω–µ –≥–∞—Ä–∞–Ω—Ç—É—î	‚úÖ	–Ω–µ–ø–µ—Ä–µ–¥–±–∞—á—É–≤–∞–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫
.forEachOrdered()	–≥–∞—Ä–∞–Ω—Ç—É—î	‚úÖ	–ø–æ—Ä—è–¥–æ–∫ —Ü—ñ–Ω–æ—é —à–≤–∏–¥–∫–æ—Å—Ç—ñ
reduce()	–±–µ–∑–ø–µ—á–Ω–∏–π –ª–∏—à–µ –¥–ª—è –∞—Å–æ—Ü—ñ–∞—Ç–∏–≤–Ω–∏—Ö	‚úÖ	—ñ–Ω–∞–∫—à–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ–ø–µ—Ä–µ–¥–±–∞—á—É–≤–∞–Ω–∏–π

üß† –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ parallelStream() –ª–∏—à–µ –¥–ª—è CPU-heavy –æ–±—á–∏—Å–ª–µ–Ω—å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –º–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∏—Ö –∑–∞–¥–∞—á).
–î–ª—è IO, –ª–æ–≥—É–≤–∞–Ω–Ω—è —á–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä ‚Äî —Ü–µ —Ç—ñ–ª—å–∫–∏ –ø–æ–≥—ñ—Ä—à—É—î –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å.