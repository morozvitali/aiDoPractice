üßµ THREADS MODULE 03 ‚Äî Locks & Deadlocks

üéØ –ú–µ—Ç–∞ –º–æ–¥—É–ª—è:
–ù–∞–≤—á–∏—Ç–∏—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—å ReentrantLock, —É–Ω–∏–∫–∞—Ç–∏ ‚Äú–º–µ—Ä—Ç–≤–∏—Ö –æ–±—ñ–π–º—ñ–≤‚Äù (deadlocks),
–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ tryLock(), —ñ –∑—Ä–æ–∑—É–º—ñ—Ç–∏, –∫–æ–ª–∏ –≤–∞—Ä—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–∏ –≤—ñ–¥ synchronized –¥–æ –±—ñ–ª—å—à –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–æ–≥–æ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 1: ReentrantLockDemo ‚Äî –ë–µ–∑–ø–µ—á–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—É

üìã –£–º–æ–≤–∞:
–°—Ç–≤–æ—Ä–∏ —Å–ø—ñ–ª—å–Ω–∏–π –ª—ñ—á–∏–ª—å–Ω–∏–∫ —ñ –¥–≤–∞ –ø–æ—Ç–æ–∫–∏, —è–∫—ñ –∑–±—ñ–ª—å—à—É—é—Ç—å –π–æ–≥–æ 100_000 —Ä–∞–∑—ñ–≤.
–í–∏–∫–æ—Ä–∏—Å—Ç–∞–π ReentrantLock –∑–∞–º—ñ—Å—Ç—å synchronized.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

class SafeCounter {
private int count = 0;
private final ReentrantLock lock = new ReentrantLock();

    void increment() {
        lock.lock();
        try {
            count++;
        } finally {
            lock.unlock();
        }
    }

    int getCount() { return count; }
}


üí° –ú–µ—Ç–∞:
–ü–æ–±–∞—á–∏—Ç–∏ –±–∞–∑–æ–≤–∏–π —à–∞–±–ª–æ–Ω: lock ‚Üí try ‚Üí finally ‚Üí unlock.
–ë–µ–∑ finally –º–æ–∂–ª–∏–≤–∏–π –≤–∏—Ç—ñ–∫ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –≤–∏–Ω—è—Ç–∫–∞—Ö.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–ó–∞–º—ñ–Ω–∏ ReentrantLock –Ω–∞ ReentrantLock(true) (fair mode) ‚Äî –ø–æ–±–∞—á —Ä—ñ–∑–Ω–∏—Ü—é —É —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ —á–µ—Ä–≥–∏ –ø–æ—Ç–æ–∫—ñ–≤.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 2: DeadlockPair ‚Äî –ö–ª–∞—Å–∏—á–Ω–∞ –ø–∞—Å—Ç–∫–∞

üìã –£–º–æ–≤–∞:
–°—Ç–≤–æ—Ä–∏ –¥–≤–∞ –æ–±‚Äô—î–∫—Ç–∏ Lock A —ñ Lock B.
–î–≤–∞ –ø–æ—Ç–æ–∫–∏:

–ü–æ—Ç—ñ–∫ 1: –±–µ—Ä–µ A, –ø–æ—Ç—ñ–º B;

–ü–æ—Ç—ñ–∫ 2: –±–µ—Ä–µ B, –ø–æ—Ç—ñ–º A.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

Lock lockA = new ReentrantLock();
Lock lockB = new ReentrantLock();

Thread t1 = new Thread(() -> {
lockA.lock();
sleep(100);
lockB.lock();
System.out.println("Thread 1 done");
});


üíÄ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è:
–ü—Ä–æ–≥—Ä–∞–º–∞ –∑–∞–≤–∏—Å–Ω–µ. –û–±–∏–¥–≤–∞ –ø–æ—Ç–æ–∫–∏ —á–µ–∫–∞—é—Ç—å –æ–¥–∏–Ω –æ–¥–Ω–æ–≥–æ ‚Äî deadlock.

üß† –°—É—Ç—å:
Deadlock –≤–∏–Ω–∏–∫–∞—î, –∫–æ–ª–∏ –ø–æ—Ç–æ–∫–∏ –±–µ—Ä—É—Ç—å —Ä–µ—Å—É—Ä—Å–∏ –≤ —Ä—ñ–∑–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–í–∏–≤–µ–¥–∏ —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–æ—Ç–æ–∫—ñ–≤ –ø–µ—Ä–µ–¥ –∑–∞–≤–∏—Å–∞–Ω–Ω—è–º ‚Äî –ø–æ–±–∞—á–µ—à ‚ÄúWAITING‚Äù —É —Å—Ç–∞–Ω—ñ.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 3: TryLockSolution ‚Äî –ë–µ–∑–ø–µ—á–Ω–µ —É–Ω–∏–∫–Ω–µ–Ω–Ω—è deadlock

üìã –£–º–æ–≤–∞:
–í—ñ–∑—å–º–∏ –∫–æ–¥ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è, –∞–ª–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π tryLock(long timeout, TimeUnit unit)
–¥–ª—è —Å–ø—Ä–æ–±–∏ –∑–∞—Ö–æ–ø–ª–µ–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—É –∑ —Ç–∞–π–º-–∞—É—Ç–æ–º.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

if (lockA.tryLock(100, TimeUnit.MILLISECONDS)) {
try {
if (lockB.tryLock(100, TimeUnit.MILLISECONDS)) {
try {
// critical section
} finally {
lockB.unlock();
}
}
} finally {
lockA.unlock();
}
}


üí° –ú–µ—Ç–∞:
–ü–æ–∫–∞–∑–∞—Ç–∏, —â–æ –º–æ–∂–Ω–∞ —É–Ω–∏–∫–∞—Ç–∏ –∑–∞–≤–∏—Å–∞–Ω—å, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ ‚Äú–º‚Äô—è–∫—ñ‚Äù —Å–ø—Ä–æ–±–∏ –∑–∞–º—ñ—Å—Ç—å –±–µ–∑—É–º–æ–≤–Ω–æ–≥–æ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–î–æ–¥–∞–π –ª–æ–≥—ñ–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ—ó —Å–ø—Ä–æ–±–∏, —è–∫—â–æ tryLock() –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞–≤.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 4: ReadWriteLockLab ‚Äî –ü–∞—Ä–∞–ª–µ–ª—å–Ω—ñ —á–∏—Ç–∞—á—ñ, –æ–¥–∏–Ω –ø–∏—Å–∞—á

üìã –£–º–æ–≤–∞:
–†–µ–∞–ª—ñ–∑—É–π DataContainer —ñ–∑ –ø–æ–ª–µ–º int value.

read() —á–∏—Ç–∞—î –∑–Ω–∞—á–µ–Ω–Ω—è

write() –∑–º—ñ–Ω—é—î –∑–Ω–∞—á–µ–Ω–Ω—è
–í–∏–∫–æ—Ä–∏—Å—Ç–∞–π ReentrantReadWriteLock, —â–æ–± –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–µ —á–∏—Ç–∞–Ω–Ω—è, –∞–ª–µ –±–ª–æ–∫—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Å.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

class DataContainer {
private int value;
private final ReentrantReadWriteLock rwLock = new ReentrantReadWriteLock();

    void write(int v) {
        rwLock.writeLock().lock();
        try { value = v; } finally { rwLock.writeLock().unlock(); }
    }

    int read() {
        rwLock.readLock().lock();
        try { return value; } finally { rwLock.readLock().unlock(); }
    }
}


üí° –ú–µ—Ç–∞:
–í—ñ–¥—á—É—Ç–∏ —Ä—ñ–∑–Ω–∏—Ü—é –º—ñ–∂ lock-–∞–º–∏ –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è –π –∑–∞–ø–∏—Å—É ‚Äî
—Ü–µ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç concurrency (–æ—Å–æ–±–ª–∏–≤–æ –¥–ª—è –∫–µ—à—ñ–≤, –∫–æ–ª–µ–∫—Ü—ñ–π, –ª–æ–≥—ñ–≤).

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–ó–∞–ø—É—Å—Ç–∏ 5 —á–∏—Ç–∞—á—ñ–≤ —ñ 1 –ø–∏—Å–∞—á–∞ ‚Äî –≤–∏–º—ñ—Ä—è–π, —è–∫ —á–∞—Å—Ç–æ –∫–æ–∂–µ–Ω –æ—Ç—Ä–∏–º—É—î –¥–æ—Å—Ç—É–ø.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 5: LockBenchmark ‚Äî ReentrantLock vs synchronized

üìã –£–º–æ–≤–∞:
–ü–æ—Ä—ñ–≤–Ω—è–π –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –¥–≤–æ—Ö –ø—ñ–¥—Ö–æ–¥—ñ–≤ –ø—Ä–∏ 10 –ø–æ—Ç–æ–∫–∞—Ö √ó 1_000_000 —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç—ñ–≤.

—á–µ—Ä–µ–∑ synchronized

—á–µ—Ä–µ–∑ ReentrantLock

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

long start = System.nanoTime();
// –∑–∞–ø—É—Å–∫ –ø–æ—Ç–æ–∫—ñ–≤
long end = System.nanoTime();
System.out.println("Time: " + (end - start)/1_000_000 + " ms");


üí° –ú–µ—Ç–∞:
–ü–æ–±–∞—á–∏—Ç–∏, —â–æ —Ä—ñ–∑–Ω–∏—Ü—è –Ω–µ–≤–µ–ª–∏–∫–∞, –∞–ª–µ Lock –¥–∞—î –±—ñ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—é (—Ç–∞–π–º-–∞—É—Ç–∏, —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ñ—Å—Ç—å, –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–Ω—É).

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–°–ø—Ä–æ–±—É–π –æ–¥–Ω–æ—á–∞—Å–Ω–æ –¥–æ–¥–∞–≤–∞—Ç–∏ –π —á–∏—Ç–∞—Ç–∏ (—è–∫ —É read-write –ø–∞—Ç–µ—Ä–Ω—ñ) ‚Äî –ø–æ–±–∞—á, —è–∫ Lock –≤–∏–≥—Ä–∞—î –∑–∞ –≥–Ω—É—á–∫—ñ—Å—Ç—é.

üí¨ –ü—ñ—Å–ª—è–º–æ–≤–∞

üß† –ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –º–æ–¥—É–ª—è —Ç–∏:

–≤–æ–ª–æ–¥—ñ—î—à ReentrantLock —ñ —Ä–æ–∑—É–º—ñ—î—à, –∫–æ–ª–∏ –≤—ñ–Ω –ø–æ—Ç—Ä—ñ–±–µ–Ω –∑–∞–º—ñ—Å—Ç—å synchronized;

—É–º—ñ—î—à –≤—ñ–¥–ª–æ–≤–ª—é–≤–∞—Ç–∏ –π —É–Ω–∏–∫–∞—Ç–∏ deadlock-–∏;

–∑–Ω–∞—î—à, —â–æ tryLock() —ñ ReadWriteLock ‚Äî —Ü–µ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª—é –±–µ–∑–ø–µ–∫–∏ –π –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ;

–≥–æ—Ç–æ–≤–∏–π –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –º–æ–¥—É–ª—è ‚Äî ExecutorService & Futures,
–¥–µ –ø–æ—Ç–æ–∫–∏ –∫–µ—Ä—É—é—Ç—å—Å—è —á–µ—Ä–µ–∑ –ø—É–ª, –∞ –Ω–µ –≤—Ä—É—á–Ω—É.