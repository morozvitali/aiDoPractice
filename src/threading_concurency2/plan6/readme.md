üßµ THREADS MODULE 06 ‚Äî Wait / Notify & Producer‚ÄìConsumer

üéØ –ú–µ—Ç–∞ –º–æ–¥—É–ª—è:
–ó—Ä–æ–∑—É–º—ñ—Ç–∏ –º–µ—Ö–∞–Ω—ñ–∫—É wait(), notify() —ñ notifyAll() ‚Äî —Ç–æ–±—Ç–æ –Ω–∏–∑—å–∫–æ—Ä—ñ–≤–Ω–µ–≤–æ—ó –≤–∑–∞—î–º–æ–¥—ñ—ó –ø–æ—Ç–æ–∫—ñ–≤ —á–µ—Ä–µ–∑ –º–æ–Ω—ñ—Ç–æ—Ä –æ–±‚Äô—î–∫—Ç–∞.
–ü–æ–±—É–¥—É–≤–∞—Ç–∏ –∫–ª–∞—Å–∏—á–Ω—É –º–æ–¥–µ–ª—å ‚Äú–≤–∏—Ä–æ–±–Ω–∏–∫‚Äì—Å–ø–æ–∂–∏–≤–∞—á‚Äù —ñ –ø–æ–±–∞—á–∏—Ç–∏, —è–∫ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —á–µ—Ä–≥–∞ –ø–æ–¥—ñ–π.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 1: SimpleWaitNotify ‚Äî –û—á—ñ–∫—É–≤–∞–Ω–Ω—è —Å–∏–≥–Ω–∞–ª—É

üìã –£–º–æ–≤–∞:
–°—Ç–≤–æ—Ä–∏ –æ–±‚Äô—î–∫—Ç lock = new Object().
–û–¥–∏–Ω –ø–æ—Ç—ñ–∫ —á–µ–∫–∞—î —Å–∏–≥–Ω–∞–ª—É (wait()), —ñ–Ω—à–∏–π ‚Äî —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥–∏ –ø–æ–¥–∞—î —Å–∏–≥–Ω–∞–ª (notify()).

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

Object lock = new Object();

Thread waiter = new Thread(() -> {
synchronized (lock) {
System.out.println("Waiting...");
try { lock.wait(); } catch (InterruptedException e) {}
System.out.println("Got signal!");
}
});

Thread notifier = new Thread(() -> {
try { Thread.sleep(2000); } catch (InterruptedException e) {}
synchronized (lock) {
System.out.println("Sending signal...");
lock.notify();
}
});

waiter.start();
notifier.start();


üí° –ú–µ—Ç–∞:
–ü–æ–±–∞—á–∏—Ç–∏, —â–æ wait() –∑–≤—ñ–ª—å–Ω—è—î –º–æ–Ω—ñ—Ç–æ—Ä —ñ —á–µ–∫–∞—î, –ø–æ–∫–∏ —ñ–Ω—à–∏–π –ø–æ—Ç—ñ–∫ –≤–∏–∫–ª–∏—á–µ notify()
(–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ç–æ–≥–æ —Å–∞–º–æ–≥–æ synchronized(lock)).

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–ó–∞–º—ñ–Ω–∏ notify() –Ω–∞ notifyAll() —ñ –¥–æ–¥–∞–π —â–µ 2 –ø–æ—Ç–æ–∫–∏, —â–æ —á–µ–∫–∞—é—Ç—å.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 2: ProducerConsumerBasic ‚Äî –û–¥–∏–Ω –≤–∏—Ä–æ–±–Ω–∏–∫, –æ–¥–∏–Ω —Å–ø–æ–∂–∏–≤–∞—á

üìã –£–º–æ–≤–∞:
–°—Ç–≤–æ—Ä–∏ –∫–ª–∞—Å DropBox, —É —è–∫–æ–º—É —î:

–ø–æ–ª–µ int value;

–ø—Ä–∞–ø–æ—Ä–µ—Ü—å available;

–º–µ—Ç–æ–¥–∏ put(int) —ñ get() –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º wait()/notifyAll().

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

class DropBox {
private int value;
private boolean available = false;

    synchronized void put(int v) {
        while (available) try { wait(); } catch (InterruptedException e) {}
        value = v;
        available = true;
        System.out.println("Produced: " + v);
        notifyAll();
    }

    synchronized int get() {
        while (!available) try { wait(); } catch (InterruptedException e) {}
        available = false;
        System.out.println("Consumed: " + value);
        notifyAll();
        return value;
    }
}


üí° –ú–µ—Ç–∞:
–ü–æ–±–∞—á–∏—Ç–∏ –∫–ª–∞—Å–∏—á–Ω–∏–π —à–∞–±–ª–æ–Ω Producer‚ÄìConsumer:
–≤–∏—Ä–æ–±–Ω–∏–∫ —á–µ–∫–∞—î, –ø–æ–∫–∏ –¥–∞–Ω—ñ –∑–Ω–∏–∫–Ω—É—Ç—å; —Å–ø–æ–∂–∏–≤–∞—á ‚Äî –ø–æ–∫–∏ –∑‚Äô—è–≤–ª—è—Ç—å—Å—è.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–î–æ–¥–∞–π –ª–æ–≥—ñ–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø—ñ—Å–ª—è 10 –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ (—ñ –≤–∏–≤—ñ–¥ ‚ÄúDone‚Äù).

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 3: BoundedBuffer ‚Äî –û–±–º–µ–∂–µ–Ω–∞ —á–µ—Ä–≥–∞

üìã –£–º–æ–≤–∞:
–°—Ç–≤–æ—Ä–∏ –±—É—Ñ–µ—Ä —ñ–∑ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ—é –¥–æ–≤–∂–∏–Ω–æ—é (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, Queue<Integer> —ñ–∑ capacity=5).
–î–µ–∫—ñ–ª—å–∫–∞ –ø–æ—Ç–æ–∫—ñ–≤ –≤–∏—Ä–æ–±–Ω–∏–∫—ñ–≤ –¥–æ–¥–∞—é—Ç—å –µ–ª–µ–º–µ–Ω—Ç–∏, –∫—ñ–ª—å–∫–∞ —Å–ø–æ–∂–∏–≤–∞—á—ñ–≤ –∑–∞–±–∏—Ä–∞—é—Ç—å.
–í–∏–∫–æ—Ä–∏—Å—Ç–∞–π wait() —ñ notifyAll() –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—é –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è/–ø–æ—Ä–æ–∂–Ω–µ—á—ñ.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

class BoundedBuffer {
private final Queue<Integer> buffer = new LinkedList<>();
private final int CAPACITY = 5;

    synchronized void put(int v) {
        while (buffer.size() == CAPACITY) try { wait(); } catch (InterruptedException e) {}
        buffer.add(v);
        System.out.println("Produced " + v + " | size=" + buffer.size());
        notifyAll();
    }

    synchronized int take() {
        while (buffer.isEmpty()) try { wait(); } catch (InterruptedException e) {}
        int val = buffer.remove();
        System.out.println("Consumed " + val + " | size=" + buffer.size());
        notifyAll();
        return val;
    }
}


üí° –ú–µ—Ç–∞:
–í—ñ–¥—á—É—Ç–∏ –ø—Ä–∏—Ä–æ–¥–Ω—É ‚Äú—Ä–∏—Ç–º—ñ–∫—É‚Äù –ø–æ—Ç–æ–∫—ñ–≤ ‚Äî –∫–æ–ª–∏ —Ö—Ç–æ—Å—å —á–µ–∫–∞—î, –∞ —Ö—Ç–æ—Å—å –ø—Ä–∞—Ü—é—î.
–¶–µ –≤–∂–µ –º–∞–π–∂–µ –∞–Ω–∞–ª–æ–≥ BlockingQueue, –∞–ª–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –≤—Ä—É—á–Ω—É.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–ó–∞–ø—É—Å—Ç–∏ 2 –≤–∏—Ä–æ–±–Ω–∏–∫–∏ + 2 —Å–ø–æ–∂–∏–≤–∞—á—ñ, –∫–æ–∂–µ–Ω —É –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–æ–º—É —Ü–∏–∫–ª—ñ.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 4: WaitTimeout ‚Äî –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑ —Ç–∞–π–º-–∞—É—Ç–æ–º

üìã –£–º–æ–≤–∞:
–ú–æ–¥–∏—Ñ—ñ–∫—É–π –∫–ª–∞—Å —ñ–∑ –∑–∞–≤–¥–∞–Ω–Ω—è 2.
–£ –º–µ—Ç–æ–¥—ñ get() –¥–æ–¥–∞–≤–∞–π –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑ —Ç–∞–π–º-–∞—É—Ç–æ–º:
—è–∫—â–æ –¥–∞–Ω–∏—Ö –Ω–µ–º–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥–∏ ‚Äî –≤–∏–≤–µ–¥–∏ "Timeout waiting for data" —ñ –ø–æ–≤–µ—Ä–Ω–∏ -1.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

while (!available) {
wait(2000);
if (!available) {
System.out.println("Timeout waiting for data");
return -1;
}
}


üí° –ú–µ—Ç–∞:
–ù–∞–≤—á–∏—Ç–∏—Å—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ wait(timeout) —è–∫ ‚Äú–º‚Äô—è–∫–µ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è‚Äù.
–¶–µ —Ä–µ–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–π —Å—Ü–µ–Ω–∞—Ä—ñ–π –¥–ª—è –º–µ—Ä–µ–∂–µ–≤–∏—Ö –∞–±–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–í–≤–µ–¥–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫ ‚ÄútimeOutCount‚Äù —ñ –ø–æ—Ä–∞—Ö—É–π, —Å–∫—ñ–ª—å–∫–∏ —Ä–∞–∑—ñ–≤ —Å–ø–æ–∂–∏–≤–∞—á –Ω–µ –¥–æ—á–µ–∫–∞–≤—Å—è.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 5: DeadlockOnWait ‚Äî –ü–æ–º–∏–ª–∫–∞ —á–µ—Ä–µ–∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –º–æ–Ω—ñ—Ç–æ—Ä

üìã –£–º–æ–≤–∞:
–°—Ç–≤–æ—Ä–∏ –∫–æ–¥, –¥–µ –ø–æ—Ç—ñ–∫ –≤–∏–∫–ª–∏–∫–∞—î wait() –Ω–∞ –æ–±‚Äô—î–∫—Ç—ñ, —è–∫–∏–π –Ω–µ –∑–∞—Ö–æ–ø–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ synchronized.
–ü–æ–±–∞—á –≤–∏–Ω—è—Ç–æ–∫ IllegalMonitorStateException.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

Object obj = new Object();
obj.wait(); // –±–µ–∑ synchronized(obj)


üí° –ú–µ—Ç–∞:
–ü–æ–∫–∞–∑–∞—Ç–∏, —â–æ wait() —ñ notify() –ø—Ä–∞—Ü—é—é—Ç—å –ª–∏—à–µ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ–≥–æ –±–ª–æ–∫—É.
–¶–µ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–∞ –≤–∏–º–æ–≥–∞, –±–µ–∑ —è–∫–æ—ó –∫–æ–¥ –Ω–µ –ø—Ä–∞—Ü—é—î.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–î–æ–¥–∞–π –ø—Ä–∞–≤–∏–ª—å–Ω—É –≤–µ—Ä—Å—ñ—é –∫–æ–¥—É, —â–æ–± –∑—Ä–æ–∑—É–º—ñ—Ç–∏ —Ä—ñ–∑–Ω–∏—Ü—é.

üí¨ –ü—ñ—Å–ª—è–º–æ–≤–∞

üß† –ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –º–æ–¥—É–ª—è —Ç–∏:

—Ä–æ–∑—É–º—ñ—î—à, —è–∫ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–∞—Ü—é—î wait() / notify();

–º–æ–∂–µ—à —Å—Ç–≤–æ—Ä–∏—Ç–∏ –≤–ª–∞—Å–Ω—É ‚Äú—á–µ—Ä–≥—É –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è‚Äù –±–µ–∑ –∫–æ–ª–µ–∫—Ü—ñ–π;

—É—Å–≤—ñ–¥–æ–º–ª—é—î—à, —è–∫ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π BlockingQueue —É java.util.concurrent;

—É–º—ñ—î—à –ø–∏—Å–∞—Ç–∏ Producer‚ÄìConsumer –±–µ–∑ –∂–æ–¥–Ω–∏—Ö –≤–∏—Å–æ–∫–æ—Ä—ñ–≤–Ω–µ–≤–∏—Ö —É—Ç–∏–ª—ñ—Ç;

–≥–æ—Ç–æ–≤–∏–π –ø–µ—Ä–µ–π—Ç–∏ –¥–æ Module 07 ‚Äî Advanced Concurrency,
–¥–µ –º–∏ –ø—ñ–¥–Ω—ñ–º–µ–º–æ—Å—å –¥–æ ConcurrentHashMap, BlockingQueue, CompletableFuture —ñ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö –æ–±—á–∏—Å–ª–µ–Ω—å.