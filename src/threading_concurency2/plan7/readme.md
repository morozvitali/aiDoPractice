üßµ THREADS MODULE 07 ‚Äî Advanced Concurrency

(ConcurrentMap, BlockingQueue, CompletableFuture)

üéØ –ú–µ—Ç–∞ –º–æ–¥—É–ª—è:
–ù–∞–≤—á–∏—Ç–∏—Å—è –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ –≤–∏—Å–æ–∫–æ—Ä—ñ–≤–Ω–µ–≤–∏–º–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∏–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏ –¥–∞–Ω–∏—Ö —Ç–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–º–∏ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è–º–∏:

ConcurrentHashMap

BlockingQueue

CompletableFuture

–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ –ª–∞–Ω—Ü—é–≥–∏ (thenApply, thenCombine, supplyAsync)

–ø–∞—Ä–∞–ª–µ–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 1: ConcurrentMapRace ‚Äî –ë–µ–∑–ø–µ—á–Ω–∞ –º–∞–ø–∞ –ø—Ä–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –æ–Ω–æ–≤–ª–µ–Ω–Ω—è—Ö

üìã –£–º–æ–≤–∞:
–°—Ç–≤–æ—Ä–∏ ConcurrentHashMap<String, Integer> scores.
10 –ø–æ—Ç–æ–∫—ñ–≤ –æ–¥–Ω–æ—á–∞—Å–Ω–æ –∑–±—ñ–ª—å—à—É—é—Ç—å —Ä–∞—Ö—É–Ω–æ–∫ "player" –Ω–∞ 1_000 —Ä–∞–∑—ñ–≤ –∫–æ–∂–µ–Ω.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

ConcurrentHashMap<String, Integer> map = new ConcurrentHashMap<>();
map.put("player", 0);

Runnable task = () -> {
for (int i = 0; i < 1000; i++) {
map.compute("player", (k, v) -> v + 1);
}
};


üí° –ú–µ—Ç–∞:
–ü–æ–±–∞—á–∏—Ç–∏, —â–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞ –∫–æ–ª–µ–∫—Ü—ñ—è –≥–∞—Ä–∞–Ω—Ç—É—î —Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å –¥–∞–Ω–∏—Ö –±–µ–∑ synchronized.
–ö–ª—é—á–æ–≤–∏–π –º–æ–º–µ–Ω—Ç ‚Äî –º–µ—Ç–æ–¥–∏ compute(), merge(), putIfAbsent() —î –∞—Ç–æ–º–∞—Ä–Ω–∏–º–∏.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–ó–∞–ø—É—Å—Ç–∏ 100 –ø–æ—Ç–æ–∫—ñ–≤ √ó 10_000 —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç—ñ–≤ ‚Äî –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≤–∂–¥–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 2: BlockingQueueChat ‚Äî –ß–µ—Ä–≥–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –º—ñ–∂ –ø–æ—Ç–æ–∫–∞–º–∏

üìã –£–º–æ–≤–∞:
–°—Ç–≤–æ—Ä–∏ BlockingQueue<String> chat = new ArrayBlockingQueue<>(5);.
–û–¥–∏–Ω –ø–æ—Ç—ñ–∫ ‚Äî ‚ÄúWriter‚Äù ‚Äî –¥–æ–¥–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—É —Å–µ–∫—É–Ω–¥—É.
–Ü–Ω—à–∏–π ‚Äî ‚ÄúReader‚Äù ‚Äî –±–µ—Ä–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ —á–µ—Ä–≥–∏ —ñ –¥—Ä—É–∫—É—î.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

BlockingQueue<String> chat = new ArrayBlockingQueue<>(5);

new Thread(() -> {
int i = 1;
try {
while (true) {
chat.put("Msg " + i++);
Thread.sleep(1000);
}
} catch (InterruptedException e) {}
}, "Writer").start();

new Thread(() -> {
try {
while (true) {
String msg = chat.take();
System.out.println(Thread.currentThread().getName() + " read: " + msg);
}
} catch (InterruptedException e) {}
}, "Reader").start();


üí° –ú–µ—Ç–∞:
–ü–æ–±–∞—á–∏—Ç–∏, —è–∫ BlockingQueue –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –±–ª–æ–∫—É—î –ø–æ—Ç–æ–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—ñ –∞–±–æ –ø–æ—Ä–æ–∂–Ω–µ—á—ñ ‚Äî –±–µ–∑ wait/notify.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–ó—Ä–æ–±–∏ –∫—ñ–ª—å–∫–∞ —á–∏—Ç–∞—á—ñ–≤ —ñ –∫—ñ–ª—å–∫–∞ –ø–∏—Å—å–º–µ–Ω–Ω–∏–∫—ñ–≤ ‚Äî ‚Äú–≥—Ä—É–ø–æ–≤–∏–π —á–∞—Ç‚Äù.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 3: CompletableFutureChain ‚Äî –õ–∞–Ω—Ü—é–≥ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö –¥—ñ–π

üìã –£–º–æ–≤–∞:
–°—Ç–≤–æ—Ä–∏ CompletableFuture, —è–∫–∏–π:

–æ–±—á–∏—Å–ª—é—î "Java" —É –≤–µ—Ä—Ö–Ω—å–æ–º—É —Ä–µ–≥—ñ—Å—Ç—Ä—ñ,

–ø–æ—Ç—ñ–º –¥–æ–¥–∞—î " is powerful",

–ø–æ—Ç—ñ–º –¥—Ä—É–∫—É—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

CompletableFuture.supplyAsync(() -> "Java")
.thenApply(String::toUpperCase)
.thenApply(s -> s + " is powerful")
.thenAccept(System.out::println);


üí° –ú–µ—Ç–∞:
–ü–æ–∫–∞–∑–∞—Ç–∏, —è–∫ –ª–∞–Ω—Ü—é–≥ –º–µ—Ç–æ–¥—ñ–≤ —É—Ç–≤–æ—Ä—é—î ‚Äú–∫–æ–Ω–≤–µ—î—Ä –æ–±—á–∏—Å–ª–µ–Ω—å‚Äù ‚Äî –∫–æ–∂–µ–Ω –∫—Ä–æ–∫ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ø—ñ—Å–ª—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ, –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–î–æ–¥–∞–π .exceptionally(ex -> "Error: " + ex.getMessage()), —â–æ–± –æ–±—Ä–æ–±–∏—Ç–∏ –ø–æ–º–∏–ª–∫–∏ –≤ –ª–∞–Ω—Ü—é–≥—É.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 4: CombineAsync ‚Äî –û–±‚Äô—î–¥–Ω–∞–Ω–Ω—è –¥–≤–æ—Ö –º–∞–π–±—É—Ç–Ω—ñ—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤

üìã –£–º–æ–≤–∞:
–Ñ –¥–≤–∞ CompletableFuture:

–æ–¥–∏–Ω –ø–æ–≤–µ—Ä—Ç–∞—î "Hello",

—ñ–Ω—à–∏–π "World".
–û–±‚Äô—î–¥–Ω–∞–π —ó—Ö —É —î–¥–∏–Ω–∏–π —Ä—è–¥–æ–∫ "Hello World" —á–µ—Ä–µ–∑ thenCombine().

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

CompletableFuture<String> f1 = CompletableFuture.supplyAsync(() -> "Hello");
CompletableFuture<String> f2 = CompletableFuture.supplyAsync(() -> "World");
CompletableFuture<String> combined = f1.thenCombine(f2, (a, b) -> a + " " + b);
System.out.println(combined.get());


üí° –ú–µ—Ç–∞:
–ü–æ–±–∞—á–∏—Ç–∏, —è–∫ –º–æ–∂–Ω–∞ –∫–æ–º–±—ñ–Ω—É–≤–∞—Ç–∏ –Ω–µ–∑–∞–ª–µ–∂–Ω—ñ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è, –Ω–µ –±–ª–æ–∫—É—é—á–∏ –ø–æ—Ç–æ–∫–∏ –≤—Ä—É—á–Ω—É.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–î–æ–¥–∞–π —Ç—Ä–µ—Ç—î CompletableFuture (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "!") —ñ –∑—Ä–æ–±–∏ —Ç—Ä–∏—Å—Ç–æ—Ä–æ–Ω–Ω—î –æ–±‚Äô—î–¥–Ω–∞–Ω–Ω—è —á–µ—Ä–µ–∑ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–µ thenCombine().

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 5: SupplyAsyncStats ‚Äî –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–ª–µ–∫—Ü—ñ—ó

üìã –£–º–æ–≤–∞:
–Ñ —Å–ø–∏—Å–æ–∫ —á–∏—Å–µ–ª –≤—ñ–¥ 1 –¥–æ 1_000_000.
–û–±—á–∏—Å–ª–∏ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ:

—Å—É–º—É (sum)

—Å–µ—Ä–µ–¥–Ω—î (avg)

–º–∞–∫—Å–∏–º—É–º (max)

–í–∏–∫–æ—Ä–∏—Å—Ç–∞–π —Ç—Ä–∏ CompletableFuture<Long> —ñ –æ–±‚Äô—î–¥–Ω–∞–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

List<Integer> data = IntStream.rangeClosed(1, 1_000_000).boxed().toList();

CompletableFuture<Long> sum = CompletableFuture.supplyAsync(() -> data.stream().mapToLong(i -> i).sum());
CompletableFuture<Double> avg = CompletableFuture.supplyAsync(() -> data.stream().mapToInt(i -> i).average().orElse(0));
CompletableFuture<Integer> max = CompletableFuture.supplyAsync(() -> data.stream().mapToInt(i -> i).max().orElse(0));

CompletableFuture.allOf(sum, avg, max).join();
System.out.println("Sum=" + sum.join() + ", Avg=" + avg.join() + ", Max=" + max.join());


üí° –ú–µ—Ç–∞:
–í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ CompletableFuture.allOf() –¥–ª—è –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ–≥–æ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫.
–£ —Ä–µ–∞–ª—å–Ω–æ–º—É –∂–∏—Ç—Ç—ñ ‚Äî —Ü–µ –±–∞–∑–∞ –¥–ª—è –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É –¥–∞–Ω–∏—Ö, –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å—ñ–≤, —Ç–æ—â–æ.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–ü–æ—Ä—ñ–≤–Ω—è–π —á–∞—Å —ñ–∑ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–∏–º –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º ‚Äî –ø–æ–±–∞—á, —è–∫ CPU —Ä–æ–∑–ø–æ–¥—ñ–ª—è—î –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º—ñ–∂ —è–¥—Ä–∞–º–∏.

üí¨ –ü—ñ—Å–ª—è–º–æ–≤–∞

üß† –ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –º–æ–¥—É–ª—è —Ç–∏:

–≤–æ–ª–æ–¥—ñ—î—à –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∏–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏ (ConcurrentHashMap, BlockingQueue);

–≤–º—ñ—î—à –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ (CompletableFuture);

—Ä–æ–∑—É–º—ñ—î—à –ø—Ä–∏–Ω—Ü–∏–ø–∏ ‚Äú–ª–∞–Ω—Ü—é–≥–æ–≤–æ—ó –æ–±—Ä–æ–±–∫–∏‚Äù (thenApply, thenCombine);

–∑–Ω–∞—î—à, —è–∫ –∫–æ–º–±—ñ–Ω—É–≤–∞—Ç–∏ –Ω–µ–∑–∞–ª–µ–∂–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –≤ –æ–¥–∏–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç;

–≥–æ—Ç–æ–≤–∏–π –ø–µ—Ä–µ–π—Ç–∏ –¥–æ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –º–æ–¥—É–ª—è ‚Äî ForkJoin & Parallel Computation,
–¥–µ –º–∏ —Ä–µ–∞–ª—ñ–∑—É—î–º–æ —Å–ø—Ä–∞–≤–∂–Ω—î —Ä–æ–∑–±–∏—Ç—Ç—è –∑–∞–¥–∞—á—ñ –Ω–∞ –ø—ñ–¥–∑–∞–¥–∞—á—ñ —á–µ—Ä–µ–∑ RecursiveTask —ñ ForkJoinPool.