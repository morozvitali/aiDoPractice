üßµ THREADS MODULE 02 ‚Äî Race Condition & Synchronization

üéØ –ú–µ—Ç–∞ –º–æ–¥—É–ª—è:
–ü–æ–±–∞—á–∏—Ç–∏ —Å–ø—Ä–∞–≤–∂–Ω—é –Ω–µ–±–µ–∑–ø–µ–∫—É –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É –¥–æ —Å–ø—ñ–ª—å–Ω–∏—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤,
–Ω–∞–≤—á–∏—Ç–∏—Å—è —ó—ó –≤–∏—è–≤–ª—è—Ç–∏, –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ —ñ –≤–∏—Ä—ñ—à—É–≤–∞—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é synchronized, –∞ —Ç–∞–∫–æ–∂ –ø–æ—Ä—ñ–≤–Ω—è—Ç–∏ –∑ Lock.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 1: UnsafeCounter ‚Äî –ù–µ–ø–µ—Ä–µ–¥–±–∞—á—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

üìã –£–º–æ–≤–∞:
–î–≤–∞ –ø–æ—Ç–æ–∫–∏ —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—é—Ç—å —Å–ø—ñ–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É int count –ø–æ 100_000 —Ä–∞–∑—ñ–≤.
–í–∏–≤–µ–¥–∏ —Ñ—ñ–Ω–∞–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è.

–û—á—ñ–∫—É–≤–∞–Ω–æ ‚Äî –≤–æ–Ω–æ –Ω—ñ–∫–æ–ª–∏ –Ω–µ –¥–æ—Ä—ñ–≤–Ω—é—î 200_000.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

class Counter {
int count = 0;
void increment() { count++; }
}


üí° –ü–æ—è—Å–Ω–µ–Ω–Ω—è:
–ß–µ—Ä–µ–∑ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó count++, –≤—ñ–¥–±—É–≤–∞—é—Ç—å—Å—è race conditions.
–û–ø–µ—Ä–∞—Ü—ñ—è —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ —Ç—Ä—å–æ—Ö –∫—Ä–æ–∫—ñ–≤ (read ‚Üí increment ‚Üí write),
—ñ –∫—ñ–ª—å–∫–∞ –ø–æ—Ç–æ–∫—ñ–≤ –º–æ–∂—É—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è –æ–¥–Ω–æ—á–∞—Å–Ω–æ.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–î–æ–¥–∞–π Thread.sleep(0, 1) —É —Ü–∏–∫–ª—ñ, —â–æ–± –∑—Ä–æ–±–∏—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É –æ—á–µ–≤–∏–¥–Ω—ñ—à–æ—é.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 2: SafeCounter ‚Äî –†—ñ—à–µ–Ω–Ω—è —á–µ—Ä–µ–∑ synchronized

üìã –£–º–æ–≤–∞:
–í—ñ–∑—å–º–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∫–æ–¥, –∞–ª–µ –¥–æ–¥–∞–π synchronized —É –º–µ—Ç–æ–¥ increment().

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

synchronized void increment() { count++; }


üí° –ü–æ—è—Å–Ω–µ–Ω–Ω—è:
–¢–µ–ø–µ—Ä –ª–∏—à–µ –æ–¥–∏–Ω –ø–æ—Ç—ñ–∫ –æ–¥–Ω–æ—á–∞—Å–Ω–æ –º–æ–∂–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ —Ü–µ–π –º–µ—Ç–æ–¥.
JVM –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î –º–æ–Ω—ñ—Ç–æ—Ä (lock) –Ω–∞ –æ–±‚Äô—î–∫—Ç—ñ this.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–ó—Ä–æ–±–∏ –æ–∫—Ä–µ–º–∏–π –º–µ—Ç–æ–¥ getCount() –±–µ–∑ synchronized ‚Äî –ø–æ–±–∞—á–∏—à, —â–æ –Ω–∞–≤—ñ—Ç—å —á–∏—Ç–∞–Ω–Ω—è –º–æ–∂–µ –±—É—Ç–∏ –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏–º.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 3: BankTransfer ‚Äî –ì–æ–Ω–∫–∏ –º—ñ–∂ —Ä–∞—Ö—É–Ω–∫–∞–º–∏

üìã –£–º–æ–≤–∞:
–Ñ –¥–≤–∞ —Ä–∞—Ö—É–Ω–∫–∏ (Account) —ñ –¥–≤–∞ –ø–æ—Ç–æ–∫–∏, —â–æ –æ–¥–Ω–æ—á–∞—Å–Ω–æ –ø–µ—Ä–µ–≤–æ–¥—è—Ç—å –≥—Ä–æ—à—ñ –º—ñ–∂ –Ω–∏–º–∏.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

class Account {
private int balance;
synchronized void transfer(Account target, int amount) {
balance -= amount;
target.balance += amount;
}
}


üí° –ü–æ—è—Å–Ω–µ–Ω–Ω—è:
–Ø–∫—â–æ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ synchronized, –±–∞–ª–∞–Ω—Å–∏ –º–æ–∂—É—Ç—å ‚Äú–∑–Ω–∏–∫–∞—Ç–∏‚Äù –∞–±–æ ‚Äú–∑'—è–≤–ª—è—Ç–∏—Å—è –∑ –ø–æ–≤—ñ—Ç—Ä—è‚Äù.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–î–æ–¥–∞–π —Ç—Ä–µ—Ç—ñ–π —Ä–∞—Ö—É–Ω–æ–∫ —ñ –ª–∞–Ω—Ü—é–≥–æ–≤—ñ –ø–µ—Ä–µ–∫–∞–∑–∏ –º—ñ–∂ –Ω–∏–º–∏ ‚Üí –ø—ñ–¥–≥–æ—Ç—É–≤–∞–Ω–Ω—è –¥–æ deadlock-—Ç–µ–º–∏.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 4: SynchronizedBlock vs Method ‚Äî –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ

üìã –£–º–æ–≤–∞:
–°—Ç–≤–æ—Ä–∏ –¥–≤–∞ –º–µ—Ç–æ–¥–∏:

synchronized void add1() ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∏–π –º–µ—Ç–æ–¥;

void add2() ‚Äî —ñ–∑ –±–ª–æ–∫–æ–º synchronized(this) –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

void add2() {
synchronized (this) {
count++;
}
}


üí° –ú–µ—Ç–∞:
–ü–æ—Ä—ñ–≤–Ω—è–π —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–≤–æ—Ö –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ (—á–µ—Ä–µ–∑ System.nanoTime()).

üß† –í–∏—Å–Ω–æ–≤–æ–∫:
–†—ñ–∑–Ω–∏—Ü—è –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∞, –∞–ª–µ –±–ª–æ–∫–∏ –±—ñ–ª—å—à –≥–Ω—É—á–∫—ñ ‚Äî –¥–æ–∑–≤–æ–ª—è—é—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –ª–∏—à–µ —á–∞—Å—Ç–∏–Ω—É –∫–æ–¥—É,
–∞ –Ω–µ –≤–µ—Å—å –º–µ—Ç–æ–¥.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–°–ø—Ä–æ–±—É–π –≤–∏–Ω–µ—Å—Ç–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é –Ω–∞ –æ–∫—Ä–µ–º–∏–π –æ–±‚Äô—î–∫—Ç Object lock = new Object() —ñ –ø–æ–±–∞—á —Ä—ñ–∑–Ω–∏—Ü—é.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 5: BenchmarkSync ‚Äî –í–∞—Ä—Ç—ñ—Å—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó

üìã –£–º–æ–≤–∞:
–ü–æ—Ä—ñ–≤–Ω—è–π —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:

–±–µ–∑ synchronized

—ñ–∑ synchronized

—ñ–∑ ReentrantLock (–ø–æ–∫–∏ –ø—Ä–æ—Å—Ç–æ, –±–µ–∑ —É–º–æ–≤)

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

ReentrantLock lock = new ReentrantLock();
lock.lock();
try { count++; } finally { lock.unlock(); }


üí° –ú–µ—Ç–∞:
–ü–æ–±–∞—á–∏—Ç–∏, —â–æ synchronized –ø—Ä–æ—Å—Ç—ñ—à–∏–π —ñ –±–µ–∑–ø–µ—á–Ω—ñ—à–∏–π —É –±—ñ–ª—å—à–æ—Å—Ç—ñ –≤–∏–ø–∞–¥–∫—ñ–≤,
–∞–ª–µ Lock –¥–æ–∑–≤–æ–ª—è—î —Ä–æ–±–∏—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ç—Ä—é–∫–∏ (—Å–ø—Ä–æ–±–∏, —Ç–∞–π–º–∞—É—Ç–∏, —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ñ—Å—Ç—å).

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–î–æ–¥–∞–π 10 –ø–æ—Ç–æ–∫—ñ–≤ –ø–æ 1_000_000 —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç—ñ–≤ —ñ –∑—Ä–æ–±–∏ –∑–∞–º—ñ—Ä–∏ —á–∞—Å—É –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –≤–∞—Ä—ñ–∞–Ω—Ç—É.

üí¨ –ü—ñ—Å–ª—è–º–æ–≤–∞

üß† –ü—ñ—Å–ª—è –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è —Ü—å–æ–≥–æ –º–æ–¥—É–ª—è —Ç–∏:

—Ä–æ–∑—É–º—ñ—î—à, —â–æ —Ç–∞–∫–µ race condition —ñ —á–æ–º—É ‚Äú–ø—Ä–æ—Å—Ç–æ ++‚Äù ‚Äî –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è;

–≤–º—ñ—î—à –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –º–µ—Ç–æ–¥–∏ —Ç–∞ –±–ª–æ–∫–∏;

–±–∞—á–∏—à —Ä—ñ–∑–Ω–∏—Ü—é –º—ñ–∂ synchronized —ñ Lock;

–≥–æ—Ç–æ–≤–∏–π –¥–æ —Ç–µ–º–∏ deadlock & tryLock(), –¥–µ –∑‚Äô—è–≤–ª—è—é—Ç—å—Å—è —Å–ø—Ä–∞–≤–∂–Ω—ñ ‚Äú–ø–∞—Å—Ç–∫–∏‚Äù –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ—Å—Ç—ñ.