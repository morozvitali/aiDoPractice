üßµ THREADS MODULE 04 ‚Äî ExecutorService & Futures

üéØ –ú–µ—Ç–∞ –º–æ–¥—É–ª—è:
–ù–∞–≤—á–∏—Ç–∏—Å—è –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ –ø—É–ª–æ–º –ø–æ—Ç–æ–∫—ñ–≤ (ExecutorService), –∑–∞–ø—É—Å–∫–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è —á–µ—Ä–µ–∑ Callable,
–æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —á–µ—Ä–µ–∑ Future, —á–µ–∫–∞—Ç–∏ –Ω–∞ –∫—ñ–ª—å–∫–∞ –∑–∞–¥–∞—á –æ–¥–Ω–æ—á–∞—Å–Ω–æ, —ñ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞—Ç–∏ executor.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 1: FixedPoolDemo ‚Äî –ü—É–ª –ø–æ—Ç–æ–∫—ñ–≤ —É –¥—ñ—ó

üìã –£–º–æ–≤–∞:
–°—Ç–≤–æ—Ä–∏ ExecutorService –∑ 4 –ø–æ—Ç–æ–∫—ñ–≤ (Executors.newFixedThreadPool(4)),
–∑–∞–ø—É—Å—Ç–∏ 10 –∑–∞–≤–¥–∞–Ω—å, –∫–æ–∂–Ω–µ –∑ —è–∫–∏—Ö –¥—Ä—É–∫—É—î "Task X running on Thread-Y" —ñ —Å–ø–∏—Ç—å 500 –º—Å.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

ExecutorService pool = Executors.newFixedThreadPool(4);
for (int i = 1; i <= 10; i++) {
int id = i;
pool.submit(() -> {
System.out.println("Task " + id + " running on " + Thread.currentThread().getName());
Thread.sleep(500);
return null;
});
}
pool.shutdown();


üí° –ú–µ—Ç–∞:
–ü–æ–±–∞—á–∏—Ç–∏, —è–∫ 10 –∑–∞–≤–¥–∞–Ω—å —Ä–æ–∑–ø–æ–¥—ñ–ª—è—é—Ç—å—Å—è –º—ñ–∂ 4 —Ä–æ–±–æ—á–∏–º–∏ –ø–æ—Ç–æ–∫–∞–º–∏.
JVM —Å–∞–º–∞ –∫–µ—Ä—É—î —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º, —á–µ—Ä–≥–æ—é —Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è–º –ø–æ—Ç–æ–∫—ñ–≤.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–ó–∞–º—ñ–Ω–∏ newFixedThreadPool(4) –Ω–∞ newCachedThreadPool() ‚Äî –ø–æ–±–∞—á –¥–∏–Ω–∞–º—ñ—á–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Ç–æ–∫—ñ–≤.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 2: SubmitAndFuture ‚Äî –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤

üìã –£–º–æ–≤–∞:
–°—Ç–≤–æ—Ä–∏ –ø—É–ª —ñ–∑ 3 –ø–æ—Ç–æ–∫—ñ–≤.
–ö–æ–∂–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è –ø–æ–≤–µ—Ä—Ç–∞—î —Ä—è–¥–æ–∫ "Result from task X".
–û—Ç—Ä–∏–º–∞–π —É—Å—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —á–µ—Ä–µ–∑ Future.get() —ñ –≤–∏–≤–µ–¥–∏ —ó—Ö —É –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

List<Future<String>> futures = new ArrayList<>();
for (int i = 1; i <= 5; i++) {
int id = i;
futures.add(pool.submit(() -> {
Thread.sleep(1000);
return "Result from task " + id;
}));
}
for (Future<String> f : futures)
System.out.println(f.get());


üí° –ú–µ—Ç–∞:
–ü–æ–±–∞—á–∏—Ç–∏, —â–æ Future.get() –±–ª–æ–∫—É—î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, –¥–æ–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –±—É–¥–µ –≥–æ—Ç–æ–≤–∏–π.
–¢–æ–±—Ç–æ –≤–∏–∫–æ–Ω—É—î ‚Äú–æ—á—ñ–∫—É–≤–∞–Ω–Ω—è‚Äù —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—ó –æ–ø–µ—Ä–∞—Ü—ñ—ó.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–í–∏–∫–æ—Ä–∏—Å—Ç–∞–π isDone() —É —Ü–∏–∫–ª—ñ, —â–æ–± –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –≥–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å –±–µ–∑ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 3: InvokeAllRace ‚Äî –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤

üìã –£–º–æ–≤–∞:
–Ñ —Ç—Ä–∏ ‚Äú—É—á–∞—Å–Ω–∏–∫–∏ –≥–æ–Ω–∫–∏‚Äù, —è–∫—ñ –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å —Ä—è–¥–æ–∫ "Runner X finished in N ms".
–ó–∞–ø—É—Å—Ç–∏ —ó—Ö —á–µ—Ä–µ–∑ invokeAll(), –¥–æ—á–µ–∫–∞–π—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≤—Å—ñ—Ö —ñ –≤–∏–≤–µ–¥–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

List<Callable<String>> tasks = List.of(
() -> run("Runner 1"),
() -> run("Runner 2"),
() -> run("Runner 3")
);
List<Future<String>> results = pool.invokeAll(tasks);
for (Future<String> f : results) System.out.println(f.get());


üí° –ú–µ—Ç–∞:
–ü–æ–±–∞—á–∏—Ç–∏, —è–∫ invokeAll() –æ–¥–Ω–æ—á–∞—Å–Ω–æ –∑–∞–ø—É—Å–∫–∞—î –≤—Å—ñ –∑–∞–¥–∞—á—ñ —ñ –ø–æ–≤–µ—Ä—Ç–∞—î –∫–æ–ª–µ–∫—Ü—ñ—é Future —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≤—Å—ñ—Ö.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–î–æ–¥–∞–π invokeAny() ‚Äî —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ª–∏—à–µ –ø–µ—Ä—à–æ–≥–æ, —Ö—Ç–æ –∑–∞–≤–µ—Ä—à–∏–≤—Å—è.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 4: CallableSum ‚Äî –ü–∞—Ä–∞–ª–µ–ª—å–Ω–µ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è

üìã –£–º–æ–≤–∞:
–Ñ —Å–ø–∏—Å–æ–∫ —á–∏—Å–µ–ª –≤—ñ–¥ 1 –¥–æ 1_000_000.
–ü–æ–¥—ñ–ª–∏ –π–æ–≥–æ –Ω–∞ 4 –ø—ñ–¥—Å–ø–∏—Å–∫–∏, –∫–æ–∂–µ–Ω —ñ–∑ —è–∫–∏—Ö –æ–±—á–∏—Å–ª—é—î —Å—É–º—É.
–ü–æ—Ç—ñ–º —Å–∫–ª–∞–¥–∏ –≤—Å—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –≤ –æ–¥–∏–Ω —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π.

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

Callable<Long> sumTask = () -> list.stream().mapToLong(i -> i).sum();
List<Future<Long>> parts = pool.invokeAll(tasks);
long total = 0;
for (Future<Long> f : parts) total += f.get();
System.out.println("Total sum = " + total);


üí° –ú–µ—Ç–∞:
–ü–æ–±–∞—á–∏—Ç–∏, —è–∫ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∞ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü—ñ—è –∑–∞–¥–∞—á—ñ –ø—Ä–∏—à–≤–∏–¥—à—É—î –æ–±—á–∏—Å–ª–µ–Ω–Ω—è.
(–¶–µ –º—ñ–Ω—ñ-–≤–µ—Ä—Å—ñ—è –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ ForkJoin-–º–æ–¥—É–ª—è.)

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–ó–∞–º—ñ—Ä–∏ —á–∞—Å —ñ–∑ System.nanoTime() —ñ –ø–æ—Ä—ñ–≤–Ω—è–π —ñ–∑ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–∏–º –æ–±—á–∏—Å–ª–µ–Ω–Ω—è–º.

‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è 5: GracefulShutdown ‚Äî –ö–æ—Ä–µ–∫—Ç–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è ExecutorService

üìã –£–º–æ–≤–∞:
–°—Ç–≤–æ—Ä–∏ –ø—É–ª –Ω–∞ 3 –ø–æ—Ç–æ–∫–∏, –∑–∞–ø—É—Å—Ç–∏ –∫—ñ–ª—å–∫–∞ –∑–∞–≤–¥–∞–Ω—å –ø–æ 1 —Å–µ–∫—É–Ω–¥—ñ.
–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –≤–∏–∫–æ–Ω–∞–π:

shutdown()

awaitTermination(3, TimeUnit.SECONDS)

–Ø–∫—â–æ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å ‚Äî shutdownNow()

üîß –ü—ñ–¥–∫–∞–∑–∫–∞:

pool.shutdown();
if (!pool.awaitTermination(3, TimeUnit.SECONDS)) {
pool.shutdownNow();
System.out.println("Forced shutdown!");
}


üí° –ú–µ—Ç–∞:
–ù–∞–≤—á–∏—Ç–∏—Å—è –∑–∞–≤–µ—Ä—à–∞—Ç–∏ —Ä–æ–±–æ—Ç—É –ø—É–ª—ñ–≤ –∫–æ—Ä–µ–∫—Ç–Ω–æ ‚Äî
—Ü–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –≤ Spring Boot, –≤–µ–±-—Å–µ—Ä–≤—ñ—Å–∞—Ö, —ñ –ø—Ä–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—ñ –±–∞–≥–∞—Ç–æ–ø–æ—Ç–æ—á–Ω–∏—Ö –∑–∞–¥–∞—á.

üß© –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
–î–æ–¥–∞–π Runtime.getRuntime().addShutdownHook() —ñ –≤–∏–≤–µ–¥–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ JVM.

üí¨ –ü—ñ—Å–ª—è–º–æ–≤–∞

üß† –ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –º–æ–¥—É–ª—è —Ç–∏:

–≤–ø–µ–≤–Ω–µ–Ω–æ —Å—Ç–≤–æ—Ä—é—î—à —ñ –∫–µ—Ä—É—î—à –ø—É–ª–∞–º–∏ –ø–æ—Ç–æ–∫—ñ–≤;

–∑–Ω–∞—î—à —Ä—ñ–∑–Ω–∏—Ü—é –º—ñ–∂ Runnable —ñ Callable;

–æ—Ç—Ä–∏–º—É—î—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —á–µ—Ä–µ–∑ Future;

–∫–µ—Ä—É—î—à –∫—ñ–ª—å–∫–æ–º–∞ –∑–∞–¥–∞—á–∞–º–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ (invokeAll, invokeAny);

—É–º—ñ—î—à –≥—Ä–∞–º–æ—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞—Ç–∏ executor –±–µ–∑ –∑–∞–≤–∏—Å–∞–Ω—å —ñ –≤—Ç—Ä–∞—Ç–∏ –∑–∞–¥–∞—á.